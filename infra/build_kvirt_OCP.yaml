---
- hosts: localhost
  gather_facts: no
  vars:
    vcenter_server: "vcenter.sample.me"
    vcenter_user: "your_deploy_user@vsphere.local"
    vcenter_pass: "enter_password_here"
    datacenter_name: "your_DC_name_here"
    resource_pool: "your_resource_pool_here"
    vcenter_cluster: "your_cluster_name_here"
    vcenter_folder: "your_folder_name_here"
    datastore: "your_datastore_name_here"
    network: "your_network_name_here"
  tasks:
  
  - name: Create Master VMs
    community.vmware.vmware_guest:
      hostname: "{{ vcenter_server }}"
      username: "{{ vcenter_user }}"
      password: "{{ vcenter_pass }}"
      validate_certs: false
      datacenter: "{{ datacenter_name }}"
      cluster: '{{ vcenter_cluster }}'
      resource_pool: '{{ resource_pool }}'
      folder: /{{ datacenter_name }}/vm/{{ vcenter_folder }}
      name: "{{ item.name }}"
      state: poweredon
      guest_id: rhel8_64Guest
      disk:
      - size_gb: 120
        type: thin
        datastore: "{{ datastore }}"
      hardware:
        version: 15
        boot_firmware: BIOS
        memory_mb: 24576
        num_cpus: 4
        scsi: paravirtual
      networks:
      - name: "{{ network }}"
        mac: "{{ item.mac }}"
        ip: "{{ item.ip }}"
        netmask: 255.255.255.0
        device_type: vmxnet3
      wait_for_ip_address: false
    delegate_to: localhost
    register: deploy_vm
    loop:
      - { name: 'master0', mac: '00:50:56:00:00:00', ip: '0.0.0.0' }
      - { name: 'master1', mac: '00:50:56:00:00:00', ip: '0.0.0.0' }
      - { name: 'master2', mac: '00:50:56:00:00:00', ip: '0.0.0.0' }

  - name: Create Worker VMs
    community.vmware.vmware_guest:
      hostname: "{{ vcenter_server }}"
      username: "{{ vcenter_user }}"
      password: "{{ vcenter_pass }}"
      validate_certs: false
      datacenter: "{{ datacenter_name }}"
      cluster: '{{ vcenter_cluster }}'
      resource_pool: '{{ resource_pool }}' 
      folder: /{{ datacenter_name }}/vm/{{ vcenter_folder }}
      name: "{{ item.name }}"
      state: poweredon
      guest_id: rhel8_64Guest
      disk:
      - size_gb: 120
        type: thin
        datastore: "{{ datastore }}"
      hardware:
        version: 15
        boot_firmware: BIOS
        memory_mb: 98304
        num_cpus: 16
        scsi: paravirtual
      networks:
      - name: "{{ network }}"
        mac: "{{ item.mac }}"
        ip: "{{ item.ip }}"
        netmask: 255.255.255.0
        device_type: vmxnet3
      - name: "{{ network }}"
        connected: no
        start_connected: no
        device_type: vmxnet3
      wait_for_ip_address: false
    delegate_to: localhost
    register: deploy_vm
    loop:
      - { name: 'worker0', mac: '00:50:56:00:00:00', ip: '0.0.0.0' }
      - { name: 'worker1', mac: '00:50:56:00:00:00', ip: '0.0.0.0' }
      - { name: 'worker2', mac: '00:50:56:00:00:00', ip: '0.0.0.0' }
